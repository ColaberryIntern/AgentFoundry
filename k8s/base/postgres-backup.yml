###############################################################################
# PostgreSQL Backup â€” CronJob + PVC
# Runs pg_dump daily at 02:00 UTC. Keeps last 30 backups.
###############################################################################
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-backups
  labels:
    app.kubernetes.io/name: postgres-backup
    app.kubernetes.io/part-of: agent-foundry
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-backup-script
  labels:
    app.kubernetes.io/name: postgres-backup
    app.kubernetes.io/part-of: agent-foundry
data:
  backup.sh: |
    #!/bin/sh
    set -e

    BACKUP_DIR="/backups"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="${BACKUP_DIR}/agent_foundry_${TIMESTAMP}.dump"
    RETENTION_COUNT=30

    echo "[$(date)] Starting PostgreSQL backup..."

    # Run pg_dump with custom format (compressed)
    PGPASSWORD="${POSTGRES_PASSWORD}" pg_dump \
      --host="${DATABASE_HOST}" \
      --port="${DATABASE_PORT}" \
      --username="${DATABASE_USER}" \
      --dbname="${DATABASE_NAME}" \
      --format=custom \
      --compress=9 \
      --file="${BACKUP_FILE}"

    FILESIZE=$(ls -lh "${BACKUP_FILE}" | awk '{print $5}')
    echo "[$(date)] Backup completed: ${BACKUP_FILE} (${FILESIZE})"

    # Cleanup: keep only the last N backups
    BACKUP_COUNT=$(ls -1 ${BACKUP_DIR}/agent_foundry_*.dump 2>/dev/null | wc -l)
    if [ "${BACKUP_COUNT}" -gt "${RETENTION_COUNT}" ]; then
      DELETE_COUNT=$((BACKUP_COUNT - RETENTION_COUNT))
      echo "[$(date)] Removing ${DELETE_COUNT} old backup(s)..."
      ls -1t ${BACKUP_DIR}/agent_foundry_*.dump | tail -n "${DELETE_COUNT}" | xargs rm -f
    fi

    echo "[$(date)] Current backups (${RETENTION_COUNT} max):"
    ls -lht ${BACKUP_DIR}/agent_foundry_*.dump 2>/dev/null || echo "  (none)"
    echo "[$(date)] Backup job finished."
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
  labels:
    app.kubernetes.io/name: postgres-backup
    app.kubernetes.io/part-of: agent-foundry
spec:
  schedule: "0 2 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 600
      template:
        metadata:
          labels:
            app.kubernetes.io/name: postgres-backup
            app.kubernetes.io/part-of: agent-foundry
        spec:
          restartPolicy: OnFailure
          containers:
            - name: pg-backup
              image: postgres:16-alpine
              command: ["/bin/sh", "/scripts/backup.sh"]
              envFrom:
                - configMapRef:
                    name: agent-foundry-config
              env:
                - name: DATABASE_HOST
                  value: postgres
                - name: DATABASE_PORT
                  value: "5432"
                - name: DATABASE_USER
                  value: agent_foundry
                - name: DATABASE_NAME
                  value: agent_foundry
                - name: POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: agent-foundry-secrets
                      key: POSTGRES_PASSWORD
              volumeMounts:
                - name: backup-volume
                  mountPath: /backups
                - name: backup-script
                  mountPath: /scripts
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 500m
                  memory: 256Mi
          volumes:
            - name: backup-volume
              persistentVolumeClaim:
                claimName: postgres-backups
            - name: backup-script
              configMap:
                name: postgres-backup-script
                defaultMode: 0755
