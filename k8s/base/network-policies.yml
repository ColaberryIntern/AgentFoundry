###############################################################################
# Network Policies
# Default-deny with explicit allow rules per service communication path.
###############################################################################
---
# ── Default deny all ingress and egress ───────────────────────────────────────
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  labels:
    app.kubernetes.io/part-of: agent-foundry
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress

---
# ── Allow all pods to reach kube-dns (UDP+TCP port 53) ────────────────────────
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  labels:
    app.kubernetes.io/part-of: agent-foundry
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
# ── api-gateway: accept ingress from nginx ingress controller ─────────────────
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-to-api-gateway
  labels:
    app.kubernetes.io/name: api-gateway
    app.kubernetes.io/part-of: agent-foundry
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: api-gateway
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 3000

---
# ── client: accept ingress from nginx ingress controller ──────────────────────
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-to-client
  labels:
    app.kubernetes.io/name: client
    app.kubernetes.io/part-of: agent-foundry
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: client
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 80

---
# ── api-gateway: allowed egress to all backend services ───────────────────────
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-api-gateway-egress
  labels:
    app.kubernetes.io/name: api-gateway
    app.kubernetes.io/part-of: agent-foundry
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: api-gateway
  policyTypes:
    - Egress
  egress:
    # to user-service
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: user-service
      ports:
        - protocol: TCP
          port: 3001
    # to compliance-monitor-service
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: compliance-monitor-service
      ports:
        - protocol: TCP
          port: 3002
    # to reporting-service
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: reporting-service
      ports:
        - protocol: TCP
          port: 3003
    # to ai-recommendation-service
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: ai-recommendation-service
      ports:
        - protocol: TCP
          port: 3004
    # to notification-service
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: notification-service
      ports:
        - protocol: TCP
          port: 3005
    # to postgres
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: postgres
      ports:
        - protocol: TCP
          port: 5432
    # to redis
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
      ports:
        - protocol: TCP
          port: 6379
    # to rabbitmq
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: rabbitmq
      ports:
        - protocol: TCP
          port: 5672

---
# ── Backend services: accept ingress from api-gateway ─────────────────────────
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-backend-ingress-from-gateway
  labels:
    app.kubernetes.io/part-of: agent-foundry
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: service
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: api-gateway
      ports:
        - protocol: TCP
          port: 3001
        - protocol: TCP
          port: 3002
        - protocol: TCP
          port: 3003
        - protocol: TCP
          port: 3004
        - protocol: TCP
          port: 3005

---
# ── Backend services: allowed egress to postgres, redis, rabbitmq ─────────────
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-backend-egress-to-datastores
  labels:
    app.kubernetes.io/part-of: agent-foundry
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: service
  policyTypes:
    - Egress
  egress:
    # to postgres
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: postgres
      ports:
        - protocol: TCP
          port: 5432
    # to redis
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
      ports:
        - protocol: TCP
          port: 6379
    # to rabbitmq
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: rabbitmq
      ports:
        - protocol: TCP
          port: 5672

---
# ── notification-service: bidirectional with rabbitmq ─────────────────────────
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-notification-rabbitmq
  labels:
    app.kubernetes.io/name: notification-service
    app.kubernetes.io/part-of: agent-foundry
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: notification-service
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: rabbitmq
      ports:
        - protocol: TCP
          port: 3005
  egress:
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: rabbitmq
      ports:
        - protocol: TCP
          port: 5672

---
# ── reporting-service: egress to rabbitmq ─────────────────────────────────────
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-reporting-rabbitmq
  labels:
    app.kubernetes.io/name: reporting-service
    app.kubernetes.io/part-of: agent-foundry
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: reporting-service
  policyTypes:
    - Egress
  egress:
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: rabbitmq
      ports:
        - protocol: TCP
          port: 5672

---
# ── ai-recommendation-service: egress to model-server ────────────────────────
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ai-recommendation-to-model-server
  labels:
    app.kubernetes.io/name: ai-recommendation-service
    app.kubernetes.io/part-of: agent-foundry
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: ai-recommendation-service
  policyTypes:
    - Egress
  egress:
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: model-server
      ports:
        - protocol: TCP
          port: 8080

---
# ── Datastores: accept ingress from services that need them ───────────────────
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-postgres-ingress
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/part-of: agent-foundry
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: postgres
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: service
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: gateway
      ports:
        - protocol: TCP
          port: 5432
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-redis-ingress
  labels:
    app.kubernetes.io/name: redis
    app.kubernetes.io/part-of: agent-foundry
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: redis
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: service
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: gateway
      ports:
        - protocol: TCP
          port: 6379
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-rabbitmq-ingress
  labels:
    app.kubernetes.io/name: rabbitmq
    app.kubernetes.io/part-of: agent-foundry
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: rabbitmq
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: service
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: gateway
      ports:
        - protocol: TCP
          port: 5672
        - protocol: TCP
          port: 15672

---
# ── Allow Prometheus scraping on all pods with metrics port ───────────────────
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-prometheus-scrape
  labels:
    app.kubernetes.io/part-of: agent-foundry
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/part-of: agent-foundry
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 3000
        - protocol: TCP
          port: 3001
        - protocol: TCP
          port: 3002
        - protocol: TCP
          port: 3003
        - protocol: TCP
          port: 3004
        - protocol: TCP
          port: 3005
        - protocol: TCP
          port: 80
